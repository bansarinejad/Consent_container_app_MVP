generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String         @id @default(uuid())
  email           String         @unique
  passwordHash    String
  displayName     String
  ageVerified     Boolean        @default(false)
  createdAt       DateTime       @default(now())
  ageToken        AgeToken?      @relation("UserAgeToken")
  ownedImages     ImageAsset[]
  sentShares      ImageShare[]   @relation("ShareSender")
  receivedShares  ImageShare[]   @relation("ShareRecipient")
  viewEvents      ViewEvent[]    @relation("ViewEventsUser")
  blocksInitiated Block[]        @relation("Blocker")
  blocksReceived  Block[]        @relation("Blocked")
  reports         Report[]
  conversationsA  Conversation[] @relation("ConversationCreator")
  conversationsB  Conversation[] @relation("ConversationPartner")
}

model AgeToken {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation("UserAgeToken", fields: [userId], references: [id])
  issuedAt  DateTime @default(now())
  expiresAt DateTime
  payload   Json
}

model Conversation {
  id        String       @id @default(uuid())
  creatorId String
  partnerId String
  creator   User         @relation("ConversationCreator", fields: [creatorId], references: [id])
  partner   User         @relation("ConversationPartner", fields: [partnerId], references: [id])
  createdAt DateTime     @default(now())
  shares    ImageShare[]
}

model ImageAsset {
  id          String       @id @default(uuid())
  ownerId     String
  owner       User         @relation(fields: [ownerId], references: [id])
  storagePath String
  createdAt   DateTime     @default(now())
  imageKey    ImageKey?
  shares      ImageShare[]
}

model ImageKey {
  id           String     @id @default(uuid())
  imageId      String     @unique
  image        ImageAsset @relation(fields: [imageId], references: [id])
  keyEncrypted String
  createdAt    DateTime   @default(now())
}

model ImageShare {
  id             String        @id @default(uuid())
  imageId        String
  senderId       String
  recipientId    String
  conversationId String?
  consentTerms   Json
  watermarkId    String
  revoked        Boolean       @default(false)
  createdAt      DateTime      @default(now())
  image          ImageAsset    @relation(fields: [imageId], references: [id])
  sender         User          @relation("ShareSender", fields: [senderId], references: [id])
  recipient      User          @relation("ShareRecipient", fields: [recipientId], references: [id])
  conversation   Conversation? @relation(fields: [conversationId], references: [id])
  viewEvents     ViewEvent[]
  reports        Report[]
}

model ViewEvent {
  id             String     @id @default(uuid())
  imageShareId   String
  viewerId       String
  viewedAt       DateTime   @default(now())
  clientInfo     Json?
  approxLocation String?
  eventType      String
  imageShare     ImageShare @relation(fields: [imageShareId], references: [id])
  viewer         User       @relation("ViewEventsUser", fields: [viewerId], references: [id])
}

model Report {
  id         String     @id @default(uuid())
  shareId    String
  reporterId String
  reason     String
  createdAt  DateTime   @default(now())
  share      ImageShare @relation(fields: [shareId], references: [id])
  reporter   User       @relation(fields: [reporterId], references: [id])
}

model Block {
  id            String   @id @default(uuid())
  blockerId     String
  blockedUserId String
  createdAt     DateTime @default(now())
  blocker       User     @relation("Blocker", fields: [blockerId], references: [id])
  blockedUser   User     @relation("Blocked", fields: [blockedUserId], references: [id])

  @@unique([blockerId, blockedUserId])
}
